import { generateResponse } from "../config/aiProviders.js";
import { extractImageRequirements, generateMultipleImages } from "../config/imageProviders.js";
import User from "../models/user.model.js";
import Website from "../models/website.model.js";
import extractJson from "../utils/extractJson.js";

const masterPrompt = `
YOU ARE A PRINCIPAL FRONTEND ARCHITECT
AND A SENIOR UI/UX ENGINEER
SPECIALIZED IN RESPONSIVE DESIGN SYSTEMS.

YOU BUILD HIGH-END, REAL-WORLD, PRODUCTION-GRADE WEBSITES
USING ONLY HTML, CSS, AND JAVASCRIPT
THAT WORK PERFECTLY ON ALL SCREEN SIZES.

THE OUTPUT MUST BE CLIENT-DELIVERABLE WITHOUT ANY MODIFICATION.

❌ NO FRAMEWORKS
❌ NO LIBRARIES
❌ NO BASIC SITES
❌ NO PLACEHOLDERS
❌ NO NON-RESPONSIVE LAYOUTS

--------------------------------------------------
USER REQUIREMENT:
{USER_PROMPT}
--------------------------------------------------

GLOBAL QUALITY BAR (NON-NEGOTIABLE)
--------------------------------------------------
- Premium, modern UI (2026–2027)
- Professional typography & spacing
- Clean visual hierarchy
- Business-ready content (NO lorem ipsum)
- Smooth transitions & hover effects
- SPA-style multi-page experience
- Production-ready, readable code

--------------------------------------------------
RESPONSIVE DESIGN (ABSOLUTE REQUIREMENT)
--------------------------------------------------
THIS WEBSITE MUST BE FULLY RESPONSIVE.

YOU MUST IMPLEMENT:

✔ Mobile-first CSS approach
✔ Responsive layout for:
  - Mobile (<768px)
  - Tablet (768px–1024px)
  - Desktop (>1024px)

✔ Use:
  - CSS Grid / Flexbox
  - Relative units (%, rem, vw)
  - Media queries

✔ REQUIRED RESPONSIVE BEHAVIOR:
  - Navbar collapses / stacks on mobile
  - Sections stack vertically on mobile
  - Multi-column layouts become single-column on small screens
  - Images scale proportionally
  - Text remains readable on all devices
  - No horizontal scrolling on mobile
  - Touch-friendly buttons on mobile

IF THE WEBSITE IS NOT RESPONSIVE → RESPONSE IS INVALID.

--------------------------------------------------
IMAGES (MANDATORY & RESPONSIVE)
--------------------------------------------------
- Use high-quality images ONLY from:
  https://images.unsplash.com/
- EVERY image URL MUST include:
  ?auto=format&fit=crop&w=1200&q=80

- Images must:
  - Be responsive (max-width: 100%)
  - Resize correctly on mobile
  - Never overflow containers

--------------------------------------------------
TECHNICAL RULES (VERY IMPORTANT)
--------------------------------------------------
- Output ONE single HTML file
- Exactly ONE <style> tag
- Exactly ONE <script> tag
- NO external CSS / JS / fonts
- Use system fonts only
- iframe srcdoc compatible
- SPA-style navigation using JavaScript
- No page reloads
- No dead UI
- No broken buttons
--------------------------------------------------
SPA VISIBILITY RULE (MANDATORY)
--------------------------------------------------
- Pages MUST NOT be hidden permanently
- If .page { display: none } is used,
  then .page.active { display: block } is REQUIRED
- At least ONE page MUST be visible on initial load
- Hiding all content is INVALID


--------------------------------------------------
REQUIRED SPA PAGES
--------------------------------------------------
- Home
- About
- Services / Features
- Contact

--------------------------------------------------
FUNCTIONAL REQUIREMENTS
--------------------------------------------------
- Navigation must switch pages using JS
- Active nav state must update
- Forms must have JS validation
- Buttons must show hover + active states
- Smooth section/page transitions

--------------------------------------------------
FINAL SELF-CHECK (MANDATORY)
--------------------------------------------------
BEFORE RESPONDING, ENSURE:

1. Layout works on mobile, tablet, desktop
2. No horizontal scroll on mobile
3. All images are responsive
4. All sections adapt properly
5. Media queries are present and used
6. Navigation works on all screen sizes
7. At least ONE page is visible without user interaction

IF ANY CHECK FAILS → RESPONSE IS INVALID

--------------------------------------------------
OUTPUT FORMAT (RAW JSON ONLY)
--------------------------------------------------
{
  "message": "Short professional confirmation sentence",
  "code": "<FULL VALID HTML DOCUMENT>"
}

--------------------------------------------------
ABSOLUTE RULES
--------------------------------------------------
- RETURN RAW JSON ONLY
- NO markdown
- NO explanations
- NO extra text
- FORMAT MUST MATCH EXACTLY
- IF FORMAT IS BROKEN → RESPONSE IS INVALID
`;

const fullStackPrompt = `
YOU ARE A SENIOR FULL-STACK ARCHITECT
SPECIALIZED IN BUILDING COMPLETE WEB APPLICATIONS.

YOU BUILD PRODUCTION-READY FULL-STACK APPLICATIONS
WITH FRONTEND AND BACKEND CODE.

--------------------------------------------------
USER REQUIREMENT:
{USER_PROMPT}
--------------------------------------------------

FULL-STACK REQUIREMENTS
--------------------------------------------------
YOU MUST PROVIDE:

1. FRONTEND (HTML/CSS/JavaScript)
   - Responsive design (mobile, tablet, desktop)
   - Modern UI with smooth interactions
   - Form validation
   - API integration code
   - Error handling

2. BACKEND (Node.js/Express)
   - RESTful API endpoints
   - Request validation
   - Error handling middleware
   - CORS configuration
   - Environment variable setup

3. DATABASE SCHEMA (if needed)
   - MongoDB/PostgreSQL schema
   - Sample data structure
   - Relationships

4. API DOCUMENTATION
   - Endpoint descriptions
   - Request/Response examples
   - Authentication requirements

--------------------------------------------------
TECHNICAL STACK
--------------------------------------------------
Frontend: HTML, CSS, JavaScript (Vanilla or specify framework)
Backend: Node.js + Express
Database: MongoDB or PostgreSQL (based on requirements)
Authentication: JWT (if needed)

--------------------------------------------------
CODE STRUCTURE
--------------------------------------------------
Provide complete, working code for:
- Frontend HTML file
- Backend server.js
- API routes
- Database models
- Configuration files
- Setup instructions

--------------------------------------------------
OUTPUT FORMAT (RAW JSON ONLY)
--------------------------------------------------
{
  "message": "Brief description of the full-stack application",
  "code": "COMPLETE FRONTEND HTML CODE HERE",
  "backend": "COMPLETE BACKEND CODE HERE (server.js)",
  "database": "DATABASE SCHEMA/MODELS HERE",
  "setup": "SETUP INSTRUCTIONS HERE"
}

--------------------------------------------------
ABSOLUTE RULES
--------------------------------------------------
- RETURN RAW JSON ONLY
- NO markdown code blocks
- NO explanations outside JSON
- ALL code must be production-ready
- Include error handling
- Add comments for clarity
- FORMAT MUST MATCH EXACTLY
`;



export const generateWebsite = async (req, res) => {
    try {
        console.log('Generate website request received:', {
            provider: req.body.provider,
            codeType: req.body.codeType,
            promptLength: req.body.prompt?.length,
            userId: req.user?._id
        })
        
        const { prompt, provider = "openrouter", codeType = "html" } = req.body
        if (!prompt) {
            return res.status(400).json({ message: "prompt is required" })
        }
        const user = await User.findById(req.user._id)

        if (!user) {
            return res.status(400).json({ message: "user not found" })
        }
        if (user.credits < 10) {
            return res.status(400).json({ message: "you have not enough credits to generate a webiste" })
        }

        console.log(`Starting generation with ${provider} for user ${user._id}, codeType: ${codeType}`)

        // Check if user wants AI-generated images
        const imagePrompts = extractImageRequirements(prompt)
        let generatedImages = []
        
        if (imagePrompts.length > 0 && process.env.BYTEZ_API_KEY) {
            console.log(`User requested images. Generating ${imagePrompts.length} images...`)
            try {
                generatedImages = await generateMultipleImages(imagePrompts)
                console.log(`Successfully generated ${generatedImages.length} images`)
            } catch (error) {
                console.error('Image generation failed, continuing without custom images:', error.message)
            }
        }

        // Choose the appropriate prompt based on code type
        let finalPrompt = codeType === "fullstack" 
            ? fullStackPrompt.replace("{USER_PROMPT}", prompt)
            : masterPrompt.replace("USER_PROMPT", prompt)
        
        // If images were generated, add them to the prompt
        if (generatedImages.length > 0) {
            finalPrompt += `\n\n--------------------------------------------------
AI-GENERATED IMAGES AVAILABLE
--------------------------------------------------
Use these AI-generated image URLs in your website:
${generatedImages.map((url, i) => `Image ${i + 1}: ${url}`).join('\n')}

IMPORTANT:
- Use these URLs directly in <img> tags
- These are real AI-generated images matching the website theme
- Do NOT use placeholder images from Unsplash
- Add proper alt text describing each image
`
        }
        
        let raw = ""
        let parsed = null
        for (let i = 0; i < 2 && !parsed; i++) {
            console.log(`Generation attempt ${i + 1} with ${provider}`)
            raw = await generateResponse(finalPrompt, provider)
            parsed = await extractJson(raw)

            if (!parsed) {
                console.log(`Attempt ${i + 1} failed, retrying with stricter prompt`)
                raw = await generateResponse(finalPrompt + "\n\nRETURN ONLY RAW JSON.", provider)
                parsed = await extractJson(raw)
            }

        }

        // Check if parsing failed completely
        if (!parsed) {
            console.error("Failed to parse JSON after all attempts")
            console.error("Raw response:", raw?.substring(0, 500))
            return res.status(400).json({ 
                message: `${provider} returned invalid JSON format. Try using OpenRouter or Groq instead.` 
            })
        }

        // Check if code field exists
        if (!parsed.code) {
            console.error("Parsed JSON missing 'code' field:", parsed)
            return res.status(400).json({ 
                message: `${provider} returned incomplete response. Try using OpenRouter or Groq instead.` 
            })
        }

        console.log('Website generated successfully, saving to database')

        const website = await Website.create({
            user: user._id,
            title: prompt.slice(0, 60),
            latestCode: parsed.code,
            conversation: [
                {
                    role: "user",
                    content: prompt
                },
                {
                    role: "ai",
                    content: parsed.message
                }
                
            ]
        })

        user.credits = user.credits - 10
        await user.save()

        console.log('Website saved, returning response')

        return res.status(201).json({
            websiteId: website._id,
            remainingCredits: user.credits
        })

    } catch (error) {
        console.error('Generate website error:', error.message)
        console.error('Error stack:', error.stack)
        return res.status(500).json({ message: `generate website error ${error}` })
    }
}


export const getWebsiteById = async (req, res) => {
    try {
        const website = await Website.findOne({
            _id: req.params.id,
            user: req.user._id
        })

        if (!website) {
            return res.status(400).json({ message: "website not found" })
        }
        return res.status(200).json(website)
    } catch (error) {
        return res.status(500).json({ message: `get website by id error ${error}` })
    }
}


export const changes = async (req, res) => {
    try {
        const { prompt, provider = "openrouter" } = req.body
        if (!prompt) {
            return res.status(400).json({ message: "prompt is required" })
        }

        const website = await Website.findOne({
            _id: req.params.id,
            user: req.user._id
        })

        if (!website) {
            return res.status(400).json({ message: "website not found" })
        }

        const user = await User.findById(req.user._id)

        if (!user) {
            return res.status(400).json({ message: "user not found" })
        }
        if (user.credits < 5) {
            return res.status(400).json({ message: "you have not enough credits to generate a webiste" })
        }

        const updatePrompt = `
UPDATE THIS HTML WEBSITE.

CURRENT CODE:
${website.latestCode}

USER REQUEST:
${prompt}

RETURN RAW JSON ONLY:
{
  "message": "Short confirmation",
  "code": "<UPDATED FULL HTML>"
}
`
        let raw = ""
        let parsed = null
        for (let i = 0; i < 2 && !parsed; i++) {
            raw = await generateResponse(updatePrompt, provider)
            parsed = await extractJson(raw)

            if (!parsed) {
                raw = await generateResponse(updatePrompt + "\n\nRETURN ONLY RAW JSON.", provider)
                parsed = await extractJson(raw)
            }

        }

        if (!parsed.code) {
            console.log("ai returned invalid response", raw)
            return res.status(400).json({ message: "ai returned invalid response" })
        }


        website.conversation.push(
            { role: "user", content: prompt },
            { role: "ai", content: parsed.message },
        )

        website.latestCode = parsed.code

        await website.save()
        user.credits = user.credits - 5
        await user.save()

        return res.status(200).json({
            message:parsed.message,
            code:parsed.code,
            remainingCredits: user.credits
        })


    } catch (error) {
        console.log(error)
 return res.status(500).json({ message: `update website error ${error}` })
    }
}



export const getAll=async (req,res) => {
    try {
        const websites=await Website.find({user:req.user._id})
        return res.status(200).json(websites)
    } catch (error) {
        return res.status(500).json({ message: `get all websites error ${error}` })
    }
}


export const deploy=async (req,res)=>{
    try {
         const website = await Website.findOne({
            _id: req.params.id,
            user: req.user._id
        })

        if (!website) {
            return res.status(400).json({ message: "website not found" })
        }

        if(!website.slug){
            website.slug=website.title.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,60)+website._id.toString().slice(-5)              
        }

        website.deployed=true
        website.deployUrl=`${process.env.FRONTEND_URL}/site/${website.slug}`
        await website.save()

        return res.status(200).json({
            url:website.deployUrl
        })

    } catch (error) {
         return res.status(500).json({ message: `deploy website error ${error}` })
    }
}


export const getBySlug=async (req,res) => {
    try {
         const website = await Website.findOne({
            slug: req.params.slug
        })

        if (!website) {
            return res.status(400).json({ message: "website not found" })
        }
          return res.status(200).json(website)
    } catch (error) {
        return res.status(500).json({ message: `get by slug website error ${error}` })
    }
}


export const deleteWebsite = async (req, res) => {
    try {
        const website = await Website.findOne({
            _id: req.params.id,
            user: req.user._id
        })

        if (!website) {
            return res.status(400).json({ message: "website not found" })
        }

        await Website.deleteOne({ _id: req.params.id })

        return res.status(200).json({ message: "website deleted successfully" })
    } catch (error) {
        return res.status(500).json({ message: `delete website error ${error}` })
    }
}